<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ãƒ•ãƒ«ãƒ¼ãƒ„ãƒ»ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ï¼ˆ10å•ã‚¯ãƒªã‚¢ãƒ»ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯ï¼‰</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --ink: #e5e7eb;
      --muted: #94a3b8;
      --accent: #22c55e;
      --brand: #60a5fa;
      --bar: rgba(148,163,184,.25);
      --app-vh: 100vh;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: linear-gradient(180deg,#0b1220,#0f172a 40%,#0b1220);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial,
        "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic", Meiryo, sans-serif;
      color: var(--ink);
    }
    .wrap {
      max-width: 880px;
      margin: 40px auto;
      padding: 24px;
      min-height: calc(var(--app-vh, 100vh) - 40px);
    }
    .card {
      position: relative;
      background: rgba(17,24,39,.82);
      border: 1px solid rgba(148,163,184,.15);
      box-shadow: 0 20px 40px rgba(0,0,0,.35);
      border-radius: 28px;
      padding: 34px;
      overflow: hidden;
      min-height: 560px;
    }
    .game-screen {
      position: relative;
      z-index: 1;
    }
    h1 {
      margin: 0 0 12px;
      font-weight: 800;
      font-size: clamp(22px, 3.6vw, 34px);
      letter-spacing: .2px;
    }
    .badge {
      background: rgba(96,165,250,.15);
      color: #bae6fd;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 13px;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }
    .status-block {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    .stat {
      background: #0b1020;
      border:1px solid rgba(148,163,184,.12);
      border-radius: 12px;
      padding: 14px 16px;
      min-width: 150px;
    }
    .label {
      font-size: 12px;
      color: var(--muted);
    }
    .val {
      font-size: 24px;
      font-weight: 700;
      margin-top: 4px;
    }

    .progress-area {
      margin: 28px 0 20px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      align-items: center;
    }
    .marathon {
      display: flex;
      align-items: flex-end;
      gap: 18px;
      width: 100%;
    }
    .marker {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--muted);
    }
    .marker svg {
      width: 70px;
      height: 70px;
      filter: drop-shadow(0 8px 18px rgba(15,23,42,.55));
    }
    .track {
      flex: 1;
      position: relative;
    }
    .runner-lane {
      position: relative;
      height: 105px;
      margin-bottom: 12px;
    }
    .runner {
      position: absolute;
      top: 10px;
      left: 0;
      width: 140px;
      pointer-events: none;
      animation: runner-bounce 1s ease-in-out infinite;
      transition: left .35s ease;
      transform: translate(-50%, 0);
      filter: drop-shadow(0 0 12px rgba(96,165,250,.45));
    }
    .runner.paused { animation-play-state: paused; opacity: .7; }
    .runner.celebrate { animation: runner-celebrate .5s ease-in-out infinite alternate; }
    .runner svg {
      width: 100%;
      height: auto;
      fill: none;
      stroke: var(--brand);
      stroke-width: 3;
      stroke-linecap: round;
      stroke-linejoin: round;
    }
    @keyframes runner-bounce {
      0%,100% { transform: translate(-50%, 0); }
      50% { transform: translate(-50%, -8px); }
    }
    @keyframes runner-celebrate {
      0% { transform: translate(-50%, -6px) rotate(-3deg); }
      100% { transform: translate(-50%, 6px) rotate(3deg); }
    }
    .slots {
      display: flex;
      width: 100%;
      gap: 10px;
    }
    .slot {
      flex: 1;
      height: 18px;
      border-radius: 999px;
      background: var(--bar);
      position: relative;
      overflow: hidden;
    }
    .slot::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg,#34d399,#22c55e);
      transform: scaleX(0);
      transform-origin: left;
      transition: transform .25s ease;
    }
    .slot.filled::after { transform: scaleX(1); }

    .word-board {
      margin: 24px 0;
      padding: 26px;
      background: #0a0f1d;
      border:1px dashed rgba(148,163,184,.25);
      border-radius: 22px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    .word-display {
      text-align: center;
    }
    .word-display .kana {
      font-size: clamp(36px, 5vw, 56px);
      font-weight: 800;
      letter-spacing: .05em;
      display: inline-flex;
      gap: .15em;
      flex-wrap: wrap;
      justify-content: center;
      text-align: center;
    }
    .word-display .letter {
      position: relative;
      padding-bottom: 4px;
      transition: color .2s ease;
    }
    .word-display .letter.correct {
      color: var(--accent);
    }
    .word-display .letter.wrong {
      color: var(--danger);
      text-decoration: underline wavy var(--danger);
      text-decoration-thickness: 3px;
    }
    .word-display .letter.current {
      color: #f8fafc;
      text-decoration: underline solid rgba(148,163,184,.6);
      text-decoration-thickness: 4px;
    }
    .word-display .letter.pending {
      color: var(--muted);
      opacity: .7;
    }

    .typed-display {
      padding: 14px 18px;
      background: rgba(15,23,42,.65);
      border: 1px solid rgba(148,163,184,.25);
      border-radius: 16px;
      font-size: clamp(36px, 5vw, 56px);
      min-height: 70px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: .18em;
      flex-wrap: wrap;
      text-align: center;
    }
    .typed-display.placeholder {
      color: var(--muted);
      opacity: .75;
    }
    .typed-display .letter {
      font-weight: 800;
      letter-spacing: .05em;
      transition: color .2s ease, text-shadow .2s ease;
    }
    .typed-display .letter.none {
      opacity: .4;
    }
    .typed-display .letter.hint {
      color: var(--muted);
      opacity: .6;
      font-weight: 400;
    }
    .typed-display .letter.correct {
      color: var(--accent);
      text-shadow: 0 0 10px rgba(34,197,94,.45);
    }
    .typed-display .letter.wrong {
      color: var(--danger);
      text-decoration: underline wavy var(--danger);
      text-decoration-thickness: 3px;
      text-shadow: 0 0 10px rgba(244,63,94,.35);
    }

    .input-shell {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0 0 0 0);
      white-space: nowrap;
      border: 0;
    }
    .input-shell input[type="text"] {
      opacity: 0;
      pointer-events: none;
      position: absolute;
    }
    input[disabled] { opacity:.65; cursor: not-allowed; }

    .controls {
      display: flex;
      gap: 12px;
      margin-top: 16px;
      flex-wrap: wrap;
    }
    button {
      padding: 10px 18px;
      border-radius: 12px;
      border:1px solid rgba(148,163,184,.22);
      background:#0b1220;
      color: var(--ink);
      cursor: pointer;
      font-weight: 700;
    }
    button.primary {
      background: linear-gradient(180deg,#2563eb,#1d4ed8);
      border-color: transparent;
    }
    button:disabled { opacity:.6; cursor: not-allowed; }

    .hint {
      color: var(--muted);
      font-size: 13px;
      margin-top: 8px;
      line-height: 1.5;
    }

    .countdown {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: clamp(48px, 8vw, 120px);
      font-weight: 800;
      color: #f8fafc;
      background: rgba(15,23,42,.85);
      opacity: 0;
      pointer-events: none;
      transition: opacity .2s ease;
      z-index: 3;
    }
    .countdown.show {
      opacity: 1;
      pointer-events: auto;
    }

    .intro-screen {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(11,17,32,.94);
      text-align: center;
      padding: 32px;
      z-index: 4;
      transition: opacity .3s ease, transform .3s ease;
    }
    .intro-screen.hidden {
      opacity: 0;
      pointer-events: none;
      transform: translateY(-12px);
    }
    .intro-content {
      max-width: 540px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      align-items: center;
    }
    .intro-content h2 {
      margin: 0;
      font-size: clamp(26px, 4vw, 38px);
    }
    .intro-content p {
      margin: 0;
      color: var(--muted);
      line-height: 1.6;
    }
    .steps {
      list-style: none;
      padding: 0;
      margin: 8px 0 0;
      width: 100%;
      text-align: left;
      color: var(--ink);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .steps li {
      background: rgba(30,41,59,.8);
      border:1px solid rgba(148,163,184,.2);
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 600;
    }
    .ime-note {
      font-size: 12px;
      color: var(--muted);
    }

    .start-hint {
      font-size: 12px;
      color: var(--muted);
    }

    @media (max-width: 640px){
      .wrap {
        padding: 16px;
        min-height: calc(var(--app-vh, 100vh) - 16px);
      }
      .card { padding: 22px; }
      .runner { width: 110px; }
      .marker svg { width: 54px; height: 54px; }
      .status-block {
        position: sticky;
        top: 0;
        z-index: 2;
        background: rgba(15,23,42,.92);
        backdrop-filter: blur(10px);
        padding: 12px 0 14px;
        border-bottom: 1px solid rgba(148,163,184,.15);
      }
      .progress-area { margin: 8px 0 0; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="game-screen" id="gameScreen">
      <h1>ãƒ•ãƒ«ãƒ¼ãƒ„ãƒ»ã‚¿ã‚¤ãƒ”ãƒ³ã‚° <span class="badge">10å•é€£ç¶šã‚¯ãƒªã‚¢ã®ã‚¿ã‚¤ãƒ ã‚’è¨ˆæ¸¬</span></h1>

        <div class="status-block">
          <div class="row" id="stats">
            <div class="stat">
              <div class="label">çµŒéæ™‚é–“</div>
              <div class="val" id="elapsed">0.0s</div>
            </div>
            <div class="stat">
              <div class="label">ã‚¯ãƒªã‚¢æ•°</div>
              <div class="val"><span id="cleared">0</span> / 10</div>
            </div>
          </div>

          <div class="progress-area">
            <div class="marathon" aria-label="10åŒºé–“ã®ãƒãƒ©ã‚½ãƒ³ãƒˆãƒ©ãƒƒã‚¯">
              <div class="marker">
                <svg viewBox="0 0 64 64" role="img" aria-label="ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹">
                  <rect x="10" y="10" width="6" height="46" fill="#38bdf8"></rect>
                  <rect x="48" y="10" width="6" height="46" fill="#38bdf8"></rect>
                  <rect x="16" y="10" width="32" height="14" rx="4" fill="#22c55e"></rect>
                  <path d="M16 26 L48 26" stroke="#38bdf8" stroke-width="2"></path>
                </svg>
                <span>ã‚¹ã‚¿ãƒ¼ãƒˆ</span>
              </div>
              <div class="track">
                <div class="runner-lane">
                  <div class="runner paused" id="runner" aria-hidden="true">
                    <svg viewBox="0 0 80 60">
                      <circle cx="48" cy="12" r="8"></circle>
                      <path d="M32 54 L42 32 L32 26" />
                      <path d="M42 32 L56 42" />
                      <path d="M42 32 L30 40" />
                      <path d="M42 20 L28 28" />
                      <path d="M42 20 L56 24" />
                    </svg>
                  </div>
                </div>
                <div class="progress slots" id="progress" aria-label="ã‚¯ãƒªã‚¢çŠ¶æ³ï¼ˆ10åŒºé–“ï¼‰">
                  <span class="slot"></span>
                  <span class="slot"></span>
                  <span class="slot"></span>
                  <span class="slot"></span>
                  <span class="slot"></span>
                  <span class="slot"></span>
                  <span class="slot"></span>
                  <span class="slot"></span>
                  <span class="slot"></span>
                  <span class="slot"></span>
                </div>
              </div>
              <div class="marker">
                <svg viewBox="0 0 64 64" role="img" aria-label="ã‚´ãƒ¼ãƒ«">
                  <rect x="14" y="8" width="6" height="48" fill="#fbbf24"></rect>
                  <path d="M20 10 L50 10 L42 22 L50 34 L20 34 Z" fill="#f43f5e" opacity=".9"></path>
                  <path d="M20 10 L36 10 L28 22 L36 34 L20 34 Z" fill="#fef3c7" opacity=".8"></path>
                </svg>
                <span>ã‚´ãƒ¼ãƒ«</span>
              </div>
            </div>
          </div>
        </div>

        <div class="word-board">
          <div class="word-display">
            <div class="kana" id="currentKana">---</div>
          </div>
          <div class="typed-display placeholder" id="typedDisplay" role="textbox" aria-readonly="true">
            å…¥åŠ›å†…å®¹
          </div>
        </div>

        <div class="input-shell" aria-hidden="true">
          <input
            id="input"
            type="text"
            lang="ja"
            inputmode="kana"
            autocomplete="off"
            autocorrect="off"
            autocapitalize="off"
            spellcheck="false"
            enterkeyhint="next"
            data-gramm="false"
            data-gramm_editor="false"
            placeholder=""
            disabled
          />
        </div>
        <div class="hint">
          PCã§ã‚‚ã‚¹ãƒãƒ›ã§ã‚‚æ—¥æœ¬èªå…¥åŠ›ï¼ˆã²ã‚‰ãŒãªï¼‰ã«åˆ‡ã‚Šæ›¿ãˆã¦ã€è¡¨ç¤ºã•ã‚ŒãŸã²ã‚‰ãŒãªã‚’ãã®ã¾ã¾æ‰“ã¡ã¾ã—ã‚‡ã†ã€‚
        </div>
        <div class="start-hint">
          Enterã‚­ãƒ¼ã§ã‚‚ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚’é–‹å§‹ã§ãã¾ã™ã€‚
        </div>

        <div class="controls">
          <button id="btnRestart" disabled>ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        </div>
      </div>

      <div class="intro-screen" id="introScreen" aria-live="polite">
        <div class="intro-content">
          <span class="badge">ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯ / ã²ã‚‰ãŒãªå…¥åŠ›</span>
          <h2>ãƒ•ãƒ«ãƒ¼ãƒ„ãƒ»ã‚¿ã‚¤ãƒ”ãƒ³ã‚°</h2>
          <p>ã²ã‚‰ãŒãªã§è¡¨ç¤ºã•ã‚Œã‚‹ãƒ•ãƒ«ãƒ¼ãƒ„åã‚’10å•é€£ç¶šã§æ­£è§£ã—ã€ã‚¿ã‚¤ãƒ ã‚’ç«¶ã†ã‚²ãƒ¼ãƒ ã§ã™ã€‚</p>
          <ul class="steps">
            <li>ã€Œã‚¹ã‚¿ãƒ¼ãƒˆã€ãƒœã‚¿ãƒ³ or Enterã‚­ãƒ¼ã§ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³é–‹å§‹</li>
            <li>è¡¨ç¤ºã•ã‚ŒãŸã²ã‚‰ãŒãªã‚’ãã®ã¾ã¾å…¥åŠ›ï¼ˆå¤‰æ›ä¸è¦ï¼‰</li>
            <li>æ­£è§£ã™ã‚‹ãŸã³ã«ãƒ©ãƒ³ãƒŠãƒ¼ãŒé€²ã¿ã€10å•ã§ã‚´ãƒ¼ãƒ«ï¼</li>
          </ul>
          <button class="primary" id="btnIntroStart">ã‚¹ã‚¿ãƒ¼ãƒˆï¼ˆEnterã‚­ãƒ¼ã§ã‚‚OKï¼‰</button>
          <div class="ime-note">PCã§ã‚‚æ—¥æœ¬èªå…¥åŠ›ï¼ˆã²ã‚‰ãŒãªï¼‰ã«ã—ã¦ã‹ã‚‰å§‹ã‚ã¦ãã ã•ã„ã€‚</div>
        </div>
      </div>

      <div class="countdown" id="countdown" aria-live="assertive"></div>
    </div>
  </div>

  <script>
    const FRUITS = [
      { kana: "ã‚Šã‚“ã”" },
      { kana: "ã¿ã‹ã‚“" },
      { kana: "ã¶ã©ã†" },
      { kana: "ã„ã¡ã”" },
      { kana: "ã‚‚ã‚‚" },
      { kana: "ã™ã„ã‹" },
      { kana: "ãªã—" },
      { kana: "ã‹ã" },
      { kana: "ã•ãã‚‰ã‚“ã¼" },
      { kana: "ã°ãªãª" },
      { kana: "ãã†ã„" },
      { kana: "ã±ã„ãªã£ã·ã‚‹" },
      { kana: "ã‚ã‚ã‚“" },
      { kana: "ã‚Œã‚‚ã‚“" },
      { kana: "ã‚‰ã„ã‚€" },
      { kana: "ã‚†ãš" },
      { kana: "ã‚‰ãµã‚‰ã‚“ã™" },
      { kana: "ãŠã‚Œã‚“ã˜" },
      { kana: "ã±ã±ã„ã‚„" },
      { kana: "ã‚ã‚“ãš" },
      { kana: "ã–ãã‚" },
      { kana: "ãã‚Š" },
      { kana: "ã™ã‚‚ã‚‚" },
      { kana: "ã„ã¡ã˜ã" }
    ];

    const GOAL_COUNT = 10;
    const RUNNER_POSITIONS = Array.from({ length: GOAL_COUNT + 1 }, (_, idx) =>
      `${(idx / GOAL_COUNT) * 100}%`
    );
    const state = {
      words: [],
      idx: 0,
      startedAt: null,
      finished: false,
      timerId: null,
      correct: 0,
      countdownActive: false,
      countdownTimeouts: [],
      charIdx: 0,
      lastWrong: false,
      lastWrongChar: "",
      pendingInput: "",
    };

    const $ = (sel) => document.querySelector(sel);
    const fmt = (n, digits = 1) =>
      (Math.round(n * Math.pow(10, digits)) / Math.pow(10, digits)).toFixed(digits);

    const introScreen = $("#introScreen");
    const btnIntroStart = $("#btnIntroStart");
    const inputField = $("#input");
    const narrowScreen = window.matchMedia("(max-width: 768px)");
    const wordDisplay = document.querySelector(".word-display");
    const typedDisplay = $("#typedDisplay");

    function shuffle(arr){
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
      return a;
    }

    function focusInput(preventScroll = false){
      const field = inputField;
      if(!field || field.disabled) return;
      try {
        if(preventScroll){
          field.focus({ preventScroll: true });
        } else {
          field.focus();
        }
      } catch {
        field.focus();
      }
    }

    function clearInputField(options = {}){
      const { immediate = false, blur = false, refocus = false } = options;
      const field = inputField;
      if(!field) return;
      if(blur){
        field.blur();
      }
      const exec = () => {
        field.value = "";
        try { field.setSelectionRange(0,0); } catch {}
        if(refocus){
          focusInput(true);
        }
        state.pendingInput = "";
        renderTypedDisplay();
      };
      if(immediate){
        exec();
      } else {
        requestAnimationFrame(exec);
      }
    }

    function updateViewportHeight(){
      const vh = window.visualViewport ? window.visualViewport.height : window.innerHeight;
      document.documentElement.style.setProperty("--app-vh", `${vh}px`);
    }

    function handleInputFocus(){
      if(!narrowScreen.matches) return;
      setTimeout(() => {
        inputField?.scrollIntoView({ behavior: "smooth", block: "center" });
      }, 80);
    }

    function renderWordProgress(){
      const box = $("#currentKana");
      if(!box) return;
      const word = state.words[state.idx]?.kana || "";
      const chars = Array.from(word);
      box.innerHTML = "";
      if(!chars.length){
        box.textContent = "---";
        return;
      }
      chars.forEach((char, idx) => {
        const span = document.createElement("span");
        span.textContent = char;
        span.classList.add("letter");
        if(idx < state.charIdx){
          span.classList.add("correct");
        } else if(idx === state.charIdx){
          span.classList.add(state.lastWrong ? "wrong" : "current");
        } else {
          span.classList.add("pending");
        }
        box.appendChild(span);
      });
    }

    function renderTypedDisplay(){
      if(!typedDisplay) return;
      typedDisplay.innerHTML = "";
      typedDisplay.classList.remove("placeholder");
      const word = state.words[state.idx]?.kana || "";
      const typed = word.slice(0, state.charIdx);
      const pending = state.pendingInput;
      if(!typed && !state.lastWrong && !pending){
        typedDisplay.classList.add("placeholder");
        typedDisplay.textContent = "å…¥åŠ›å†…å®¹";
        return;
      }
      if(typed){
        const ok = document.createElement("span");
        ok.className = "letter correct";
        ok.textContent = typed;
        typedDisplay.appendChild(ok);
      }
      if(state.lastWrong && state.lastWrongChar){
        const wrong = document.createElement("span");
        wrong.className = "letter wrong";
        wrong.textContent = state.lastWrongChar;
        typedDisplay.appendChild(wrong);
      }
      if(pending){
        const hint = document.createElement("span");
        hint.className = "letter hint";
        hint.textContent = pending;
        typedDisplay.appendChild(hint);
      }
    }

    function ensureWordPool(){
      if(state.idx >= state.words.length){
        state.words = state.words.concat(shuffle(FRUITS));
      }
    }

    function showCurrentWord(){
      ensureWordPool();
      state.charIdx = 0;
      state.lastWrong = false;
      state.lastWrongChar = "";
      state.pendingInput = "";
      renderWordProgress();
      renderTypedDisplay();
    }

    function updateProgress(){
      $("#cleared").textContent = state.correct;
      document.querySelectorAll(".progress .slot").forEach((slot, idx) => {
        slot.classList.toggle("filled", idx < state.correct);
      });
    }

    function updateRunnerPosition(){
      const runner = $("#runner");
      if(!runner) return;
      const idx = Math.min(state.correct, RUNNER_POSITIONS.length - 1);
      runner.style.left = RUNNER_POSITIONS[idx];
    }

    function updateStats(){
      const elapsed = state.startedAt ? Date.now() - state.startedAt : 0;
      $("#elapsed").textContent = fmt(elapsed / 1000, 1) + "s";
    }

    function setRunnerState(){
      const runner = $("#runner");
      if(!runner) return;
      const paused = !state.startedAt || state.finished;
      runner.classList.toggle("paused", paused);
      runner.classList.toggle("celebrate", state.finished);
    }

    function tick(){
      if(state.startedAt && !state.finished){
        updateStats();
      }
    }

    function clearCountdown(){
      state.countdownTimeouts.forEach((id)=>clearTimeout(id));
      state.countdownTimeouts = [];
      state.countdownActive = false;
      const overlay = $("#countdown");
      overlay.classList.remove("show");
      overlay.textContent = "";
    }

    function toggleIntro(show){
      if(!introScreen) return;
      introScreen.classList.toggle("hidden", !show);
      introScreen.setAttribute("aria-hidden", show ? "false" : "true");
      if(btnIntroStart){
        btnIntroStart.disabled = false;
      }
    }

    function init(showIntro = false){
      clearInterval(state.timerId);
      state.timerId = null;
      clearCountdown();
      state.words = shuffle(FRUITS);
      state.idx = 0;
      state.startedAt = null;
      state.finished = false;
      state.correct = 0;
      state.charIdx = 0;
      state.lastWrong = false;
      state.lastWrongChar = "";
      state.pendingInput = "";
      clearInputField({ immediate: true });
      $("#input").disabled = true;
      $("#btnRestart").disabled = true;
      updateProgress();
      updateStats();
      updateRunnerPosition();
      showCurrentWord();
      setRunnerState();
      if(showIntro){
        toggleIntro(true);
      } else {
        toggleIntro(false);
      }
    }

    function beginRun(){
      if(state.startedAt) return;
      state.startedAt = Date.now();
      state.timerId = setInterval(tick, 100);
      $("#input").disabled = false;
      focusInput(true);
      $("#btnRestart").disabled = false;
      setRunnerState();
    }

    function startCountdown(){
      if(state.countdownActive || state.startedAt || state.finished) return;
      state.countdownActive = true;
      if(btnIntroStart) btnIntroStart.disabled = true;
      const overlay = $("#countdown");
      const steps = ["3","2","1"];
      overlay.textContent = "";
      overlay.classList.add("show");
      steps.forEach((val, idx) => {
        const id = setTimeout(() => {
          overlay.textContent = val;
          if(idx === steps.length - 1){
            const startId = setTimeout(() => {
              overlay.classList.remove("show");
              overlay.textContent = "";
              state.countdownActive = false;
              beginRun();
            }, 800);
            state.countdownTimeouts.push(startId);
          }
        }, idx * 800);
        state.countdownTimeouts.push(id);
      });
    }

    function requestStart(){
      if(state.countdownActive || state.startedAt || state.finished) return;
      toggleIntro(false);
      startCountdown();
    }

    function handleCorrect(){
      state.correct++;
      state.idx++;
      state.charIdx = 0;
      state.lastWrong = false;
      state.lastWrongChar = "";
      state.pendingInput = "";
      renderTypedDisplay();
      clearInputField({ refocus: true });
      updateProgress();
      updateRunnerPosition();
      if(state.correct >= GOAL_COUNT){
        finish();
      } else {
        showCurrentWord();
      }
    }

    function consumeInput(value){
      if(!value) return;
      const chars = Array.from(value);
      clearInputField({ immediate: true });
      chars.forEach(ch => attemptChar(ch));
    }

    function isAllHiragana(str){
      return /^[\u3040-\u309Fãƒ¼]+$/.test(str);
    }

    function handleInput(event){
      if(!state.startedAt || state.finished) return;
      const value = inputField?.value || "";
      const isComposingEvent =
        event && (event.isComposing || event.type === "compositionupdate");

      if(isComposingEvent){
        state.pendingInput = value;
        if(isAllHiragana(value)){
          consumeInput(value);
          state.pendingInput = "";
        } else {
          renderTypedDisplay();
        }
        return;
      }

      if(!value){
        state.pendingInput = "";
        renderTypedDisplay();
        return;
      }

      state.pendingInput = "";
      consumeInput(value);
    }

    function attemptChar(ch){
      const current = state.words[state.idx] || { kana: "" };
      const chars = Array.from(current.kana);
      const targetChar = chars[state.charIdx];
      if(!targetChar) return;
      if(ch === targetChar){
        state.charIdx++;
        state.lastWrong = false;
        state.lastWrongChar = "";
        state.pendingInput = "";
        renderWordProgress();
        renderTypedDisplay();
        if(state.charIdx >= chars.length){
          handleCorrect();
        }
      } else {
        state.lastWrong = true;
        state.lastWrongChar = ch;
        state.pendingInput = "";
        renderWordProgress();
        renderTypedDisplay();
      }
    }

    function handleBackspaceKey(){
      if(!state.startedAt || state.finished) return false;
      if(state.pendingInput){
        state.pendingInput = state.pendingInput.slice(0, -1);
        renderTypedDisplay();
        return true;
      }
      if(state.lastWrong){
        state.lastWrong = false;
        state.lastWrongChar = "";
        renderWordProgress();
        renderTypedDisplay();
        return true;
      }
      if(state.charIdx > 0){
        state.charIdx = Math.max(0, state.charIdx - 1);
        renderWordProgress();
        renderTypedDisplay();
        return true;
      }
      return false;
    }

    function finish(){
      if(state.finished) return;
      state.finished = true;
      clearInterval(state.timerId);
      state.timerId = null;
      $("#input").disabled = true;
      updateStats();
      setRunnerState();
      updateRunnerPosition();
      const total = state.startedAt ? fmt((Date.now() - state.startedAt)/1000, 1) : "0.0";
      setTimeout(()=>alert(`ğŸ 10å•ã‚¯ãƒªã‚¢ï¼ã‚¿ã‚¤ãƒ : ${total}s`), 80);
    }

    updateViewportHeight();
    window.addEventListener("resize", updateViewportHeight);
    if(window.visualViewport){
      window.visualViewport.addEventListener("resize", updateViewportHeight);
    }

    if(btnIntroStart){
      btnIntroStart.addEventListener("click", requestStart);
    }
    $("#btnRestart").addEventListener("click", () => init(true));
    if(inputField){
      inputField.addEventListener("input", handleInput);
      inputField.addEventListener("focus", handleInputFocus);
      inputField.addEventListener("compositionupdate", handleInput);
      inputField.addEventListener("compositionend", handleInput);
      inputField.addEventListener("keydown", (e) => {
        if(e.key === "Backspace" && !e.isComposing){
          if(inputField.value.length){
            return;
          }
          if(handleBackspaceKey()){
            e.preventDefault();
          }
        }
      });
    }
    if(wordDisplay){
      ["click","touchend"].forEach(evt => {
        wordDisplay.addEventListener(evt, () => focusInput(true));
      });
    }
    if(typedDisplay){
      ["click","touchend"].forEach(evt => {
        typedDisplay.addEventListener(evt, () => focusInput(true));
      });
    }
    document.addEventListener("keydown", (e) => {
      if(e.key === "Enter" && !e.isComposing){
        if(!state.startedAt && !state.countdownActive && !state.finished){
          e.preventDefault();
          requestStart();
        }
      }
    });

    init(true);
  </script>
</body>
</html>
